#!/bin/sh
# shellcheck shell=sh
# Version: 0.3.0
#
# deva-bridge-tmux-host - Host-side tmux bridge for deva containers
#
# Expose host tmux Unix socket over TCP for container access.
# Problem: Unix socket mount across macOS<->Linux kernel boundary fails.
# Solution: socat TCP proxy, container connects via host.docker.internal.
#
# SECURITY WARNING:
#   This is a PRIVILEGED HOST BRIDGE. Container gains full tmux control.
#   Any process reaching the TCP port can send-keys, run-shell, read scrollback.
#   Effectively "container can run commands on host".

set -eu
umask 077

prog=${0##*/}
VERSION=0.3.0

EXIT_OK=0
EXIT_ERROR=1
EXIT_NOTFOUND=3

QUIET=0
PORT="${DEVA_BRIDGE_PORT:-41555}"
BIND="${DEVA_BRIDGE_BIND:-127.0.0.1}"
SOCKET="${DEVA_BRIDGE_SOCKET:-}"

# --- util ---

log() { [ "$QUIET" -eq 1 ] || printf '%s\n' "$*"; }
warn() { printf '%s\n' "$*" >&2; }
err() { printf '%s\n' "$*" >&2; }
die() { err "$prog: error: $*"; exit "$EXIT_ERROR"; }

usage() {
  cat <<EOF
$prog - host-side tmux bridge for deva containers

USAGE:
  $prog [OPTIONS]

OPTIONS:
  -b, --bind ADDR   bind address (default: 127.0.0.1)
                    use 0.0.0.0 if host.docker.internal can't reach loopback
  -p, --port PORT   TCP port to listen on (default: 41555)
  -s, --socket PATH tmux socket path (auto-detected if omitted)
  -q, --quiet       suppress non-error output
  -h, --help        show this help
  -V, --version     show version

ENV:
  DEVA_BRIDGE_BIND    bind address (default: 127.0.0.1)
  DEVA_BRIDGE_PORT    TCP port (default: 41555)
  DEVA_BRIDGE_SOCKET  tmux socket path (auto-detected)

SECURITY:
  This is a PRIVILEGED HOST BRIDGE. Container gains full tmux control.
  - bind=127.0.0.1: any LOCAL process can connect (reduced exposure)
  - bind=0.0.0.0: any NETWORK client can connect (dangerous)
  Either way, connecting client can send-keys, run-shell, read scrollback.

EXAMPLES:
  $prog
  $prog -b 0.0.0.0 -p 51555
  DEVA_BRIDGE_BIND=0.0.0.0 $prog

CONTAINER USAGE:
  deva-bridge-tmux
  tmux -S /tmp/host-tmux.sock list-sessions
EOF
}

version() { printf '%s %s\n' "$prog" "$VERSION"; }

require() {
  command -v "$1" >/dev/null 2>&1 || die "missing dependency: $1"
}

security_warning() {
  warn "============================================"
  warn "WARNING: PRIVILEGED HOST BRIDGE (tmux)"
  warn "============================================"
  warn "Container can execute commands on host via tmux."
  if [ "$BIND" = "127.0.0.1" ]; then
    warn "Binding $BIND:$PORT - LOCAL processes gain tmux control."
  else
    warn "Binding $BIND:$PORT - NETWORK clients gain tmux control."
  fi
  warn ""
}

# --- parse options ---

while [ $# -gt 0 ]; do
  case $1 in
    -h|--help) usage; exit "$EXIT_OK" ;;
    -V|--version) version; exit "$EXIT_OK" ;;
    -q|--quiet) QUIET=1 ;;
    -b|--bind)
      [ $# -ge 2 ] || die "missing value for $1"
      BIND="$2"; shift ;;
    -p|--port)
      [ $# -ge 2 ] || die "missing value for $1"
      PORT="$2"; shift ;;
    -s|--socket)
      [ $# -ge 2 ] || die "missing value for $1"
      SOCKET="$2"; shift ;;
    --) shift; break ;;
    -*) die "unknown option: $1" ;;
    *) break ;;
  esac
  shift
done

# --- main ---

main() {
  require socat
  require tmux

  # Auto-detect socket if not specified
  if [ -z "$SOCKET" ]; then
    SOCKET=$(tmux display-message -p '#{socket_path}' 2>/dev/null || printf '')
  fi
  if [ -z "$SOCKET" ]; then
    SOCKET="/private/tmp/tmux-$(id -u)/default"
  fi

  # Validate socket exists
  if [ ! -S "$SOCKET" ]; then
    err "$prog: tmux socket not found: $SOCKET"
    err "Is tmux server running? Try: tmux new -d -s test"
    exit "$EXIT_NOTFOUND"
  fi

  security_warning

  log "deva bridge: tmux (host-side)"
  log "  socket: $SOCKET"
  log "  listen: $BIND:$PORT"
  log ""
  log "container: deva-bridge-tmux"
  log "usage:     tmux -S /tmp/host-tmux.sock list-sessions"

  exec socat \
    "TCP-LISTEN:$PORT,bind=$BIND,reuseaddr,fork" \
    "UNIX-CONNECT:$SOCKET"
}

main "$@"
